pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = "devops-demo-app"
        DOCKER_TAG = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '=== Checkout Code ==='
                checkout scm
            }
        }
        
        stage('Build Dependencies') {
            steps {
                echo '=== Installing Dependencies ==='
                sh 'npm install'
            }
        }
        
        stage('Run Tests') {
            steps {
                echo '=== Running Tests ==='
                sh 'npm test'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo '=== Building Docker Image ==='
                sh """
                    docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} .
                    docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest
                    echo "âœ“ Image built: ${DOCKER_IMAGE}:${DOCKER_TAG}"
                """
            }
        }
        
        stage('Deploy Container') {
            steps {
                echo '=== Deploying Application ==='
                sh """
                    # Remove old container
                    docker stop devops-demo 2>/dev/null || true
                    docker rm devops-demo 2>/dev/null || true
                    
                    # Deploy new container
                    docker run -d \
                        --name devops-demo \
                        -p 3001:3000 \
                        --restart unless-stopped \
                        ${DOCKER_IMAGE}:latest
                    
                    # Wait for startup
                    sleep 5
                    
                    # Verify container is running
                    if docker ps | grep -q devops-demo; then
                        echo "âœ“ Container started successfully"
                        docker logs devops-demo
                    else
                        echo "âœ— Container failed to start"
                        exit 1
                    fi
                """
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo '=== Verifying Deployment ==='
                sh '''
                    echo "Container Info:"
                    docker inspect devops-demo --format='{{.State.Status}}'
                    
                    echo ""
                    echo "Port Mappings:"
                    docker port devops-demo
                    
                    echo ""
                    echo "Recent Logs:"
                    docker logs --tail 20 devops-demo
                    
                    echo ""
                    echo "âœ… Deployment verification complete!"
                '''
            }
        }
    }
    
    post {
        success {
            script {
                def publicIP = sh(script: 'curl -s http://checkip.amazonaws.com 2>/dev/null || echo "unknown"', returnStdout: true).trim()
                echo ""
                echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                echo "â•‘               âœ… DEPLOYMENT SUCCESSFUL!                    â•‘"
                echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                echo ""
                echo "ðŸŒ Application URL: http://${publicIP}:3001"
                echo "ðŸ’š Health Check:    http://${publicIP}:3001/health"
                echo ""
                echo "ðŸ“¦ Docker Image:    ${DOCKER_IMAGE}:${DOCKER_TAG}"
                echo "ðŸ³ Container Name:  devops-demo"
                echo ""
                echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            }
        }
        failure {
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                  âŒ DEPLOYMENT FAILED!                     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "Container Logs:"
            sh 'docker logs devops-demo 2>&1 || echo "No logs available"'
            echo ""
            echo "Container Status:"
            sh 'docker ps -a | grep devops-demo || echo "Container not found"'
        }
        always {
            echo 'ðŸ§¹ Cleaning workspace...'
            cleanWs()
        }
    }
}
